
class S21Query < ApplicationQuery
  query :by_icno, <<-SQL
    SELECT a.PNUM60, a.IUNT60, INT(a.SPHY60) AS SPHY60, INT(a.SOOR60) AS SOOR60, INT(a.SALC60) AS SALC60, INT(a.SBOR60) AS SBOR60, INT(a.SAVL60) AS SAVL60, INT(a.SFRZ60) AS SFRZ60, 
      COALESCE((SELECT MIN(INTEGER(c.SAVL60/b.NOFF65)) FROM IDNMOD3.INP65S AS b
        INNER JOIN IDND1F3.INP60 AS c
          ON b.CMPT65 = c.PNUM60
          AND b.CONO65 = c.CONO60
        WHERE b.CONO65 = a.CONO60 AND b.PNUM65 = a.PNUM60 AND c.STRC60 = a.STRC60
      ),0) AS SPNT60,
      COALESCE((SELECT INT(SUM(d.AQTY71)) FROM IDND1F3.INP71 AS d
        INNER JOIN IDND1F3.OEP40 AS e ON d.ORDN71 = e.ORDN40 AND d.CONO71 = e.CONO40 AND d.LOCD71 = e.LOCD40
        WHERE d.CATN71 = a.PNUM60 AND d.CONO71 = a.CONO60 AND d.LOCD71 = a.STRC60 AND e.STAT40 <> 'C' AND a.SOOR60 > 0
        GROUP BY d.CATN71
      ),0) AS SORSV60,
      a.SITS60, a.DLIS60, a.DLRC60
    FROM IDND1F3.INP60 AS a
    WHERE a.CONO60 = 'ID' AND $a.PNUM60 = ? AND a.STRC60 = 'JK'
  SQL

  query :details, -> number {
    fetch(
      "SELECT DISTINCT ORDL70, ORDN65, DESN65, INVN65, CUSO65, INP15.PRMD15 AS DMODE, SLMN65, DESC.PRMD15 AS SENG, CATN70, PARTS.PDES35, INP40.TLIN40, OEP70.LQTY70, OEP70.EUOM70
      FROM IDND1F3.OEP65
      INNER JOIN IDND1F3.INP15 ON(
        INP15.CONO15 = OEP65.CONO65 AND
        INP15.PSAR15 = OEP65.DESM65
      )
      INNER JOIN IDND1F3.DESC ON(
        DESC.CONO15 = OEP65.CONO65 AND
        DESC.PSAR15 = OEP65.SLMN65
      )
      INNER JOIN IDND1F3.OEP70 ON(
        OEP70.CONO70 = OEP65.CONO65 AND
        OEP70.INVN70 = OEP65.INVN65
      )
      INNER JOIN IDND1F3.PARTS ON(
        PARTS.CONO35 = OEP70.CONO70 AND
        PARTS.PNUM35 = OEP70.CATN70
      )
      INNER JOIN IDND1F3.INP40 ON(
        INP40.CONO40 = OEP70.CONO70 AND
        INP40.TREF40 = OEP70.CATN70
      )
      WHERE (
        CONO65 = 'ID' AND
        TYPE65 = 'IN' AND
        INP15.PRMT15 = 'MODE' AND
        DESC.PRMT15 IN ('TM', 'SLMN', 'SE', 'TN') AND
        USGC40 = 'E' AND
        $ORDN65 = ? AND $DESN65 = ?
      )
      ORDER BY OEP70.ORDL70",
      [number[0..6], number[7..8]]
    )
  }
end
